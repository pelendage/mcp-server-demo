name: Tests and lint for MCP servers

on:
  push:
    paths:
      - "servers/**"
      - ".github/workflows/unit_tests.yml"
  pull_request:
    paths:
      - "servers/**"
      - ".github/workflows/unit_tests.yml"

jobs:
  discover:
    runs-on:
      group: databrickslabs-protected-runner-group
      labels: linux-ubuntu-latest
    outputs:
      server_dirs: ${{ steps.set-matrix.outputs.server_dirs }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discover server dirs with tests
        id: set-matrix
        run: |
          dirs=$(find servers -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/tests" \; -print | sed 's|servers/||' | jq -R . | jq -cs .)
          echo "Found directories: $dirs"
          echo "server_dirs=$dirs" >> "$GITHUB_OUTPUT"



  test:
    needs: discover
    runs-on:
      group: databrickslabs-protected-runner-group
      labels: linux-ubuntu-latest
    strategy:
      matrix:
        server-dir: ${{ fromJson(needs.discover.outputs.server_dirs) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies with uv
        working-directory: servers/${{ matrix.server-dir }}
        run: |
          uv sync
          uv pip install --group dev

      - name: Run tests
        working-directory: servers/${{ matrix.server-dir }}
        run: uv run pytest tests
  lint:
    runs-on:
      group: databrickslabs-protected-runner-group
      labels: linux-ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run lint checks
        run: ./dev/lint.sh
